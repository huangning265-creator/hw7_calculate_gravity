import gradio as gr

#  crucial import: we are importing the "brain" (the GravityStation class)
# from our "brain" file (HW_Gravity_Calculator.py)
# é—œéµï¼æˆ‘å€‘è¦å¾ã€Œå¤§è…¦ã€æª”æ¡ˆä¸­ï¼ŒåŒ¯å…¥ã€Œå¤§è…¦ã€çš„ Class
from HW_Gravity_Calculator import GravityStation

# --- Gradio ä»‹é¢çš„æ ¸å¿ƒå‡½å¼ ---
# é€™å€‹å‡½å¼å°±æ˜¯ã€Œè‡‰ã€å’Œã€Œå¤§è…¦ã€æºé€šçš„æ©‹æ¨‘

def calculate_gravity_report(station_type, lat, lon, h, g_obs, rho_rock):
    """
    Gradio æŒ‰ä¸‹æŒ‰éˆ•æ™‚ï¼Œæœƒå‘¼å«é€™å€‹å‡½å¼ã€‚
    """
    try:
        # 1. æª¢æŸ¥è¼¸å…¥çš„é¡å‹æ˜¯å¦æ­£ç¢º
        lat = float(lat)
        lon = float(lon)
        h = float(h)
        g_obs = float(g_obs)
        rho_rock = float(rho_rock)
        
        # 2. å»ºç«‹ã€Œå¤§è…¦ã€çš„å¯¦ä¾‹ (Instance)
        # æ ¹æ“šä½¿ç”¨è€…é¸æ“‡çš„é¡å‹ ("é™¸åœ°" æˆ– "æµ·æ´‹") ä¾†å»ºç«‹
        station = GravityStation(
            lat=lat,
            lon=lon,
            h=h,
            g_obs=g_obs,
            station_type=station_type.lower(), # è½‰æˆå°å¯« "land" æˆ– "marine"
            rho_rock=rho_rock
            # æˆ‘å€‘åœ¨é€™è£¡ä½¿ç”¨è‡ªå®šç¾©çš„å²©çŸ³å¯†åº¦ï¼é€™å°±æ˜¯ã€Œå½ˆæ€§ã€ï¼
        )
        
        # 3. å‘¼å«ã€Œå¤§è…¦ã€é€²è¡Œè¨ˆç®—
        station.process_all()
        
        # 4. å¾ã€Œå¤§è…¦ã€å–å¾—æ ¼å¼åŒ–çš„å ±å‘Š
        station.generate_report()
        report_text = station.report
        
        # 5. æŠŠå ±å‘Šå‚³å›çµ¦ã€Œè‡‰ã€(Gradio ä»‹é¢)
        return report_text
        
    except Exception as e:
        # å¦‚æœä½¿ç”¨è€…äº‚è¼¸å…¥ (ä¾‹å¦‚è¼¸å…¥æ–‡å­—)ï¼Œå°±æœƒåœ¨é€™è£¡å ±éŒ¯
        return f"è¨ˆç®—å‡ºéŒ¯äº†ï¼ ğŸ˜±\nè«‹æª¢æŸ¥ä½ çš„è¼¸å…¥å€¼æ˜¯å¦éƒ½æ˜¯æ•¸å­—ã€‚\néŒ¯èª¤è¨Šæ¯: {str(e)}"

# --- å»ºç«‹ Gradio ä»‹é¢ ("è‡‰") ---

# è€å¸«çš„æ­¡è¿è©
intro_markdown = """
# ğŸ‘¨â€ğŸ« åœ°çƒç‰©ç†é‡åŠ›è¨ˆç®—å·¥ä½œç«™ v2.0
(å°ˆæ¥­å¯æ“´å±•ç‰ˆ)

é€™æ˜¯ä¸€å€‹å°ˆæ¥­çš„åœ°çƒç‰©ç†è¨ˆç®—å·¥å…·ï¼Œç”±ä¸€å€‹ã€Œ**Gradio å‰ç«¯ (è‡‰)**ã€å’Œä¸€å€‹ã€Œ**Python å¾Œç«¯ (å¤§è…¦)**ã€çµ„æˆã€‚
è«‹è¼¸å…¥æ‚¨æ¸¬ç«™çš„å®Œæ•´è³‡æ–™ï¼Œæœ¬ç³»çµ±å°‡è‡ªå‹•è¨ˆç®—å®Œæ•´çš„é‡åŠ›ç•°å¸¸å ±å‘Šã€‚
"""

with gr.Blocks(theme=gr.themes.Soft(primary_hue="blue", secondary_hue="orange")) as demo:
    
    gr.Markdown(intro_markdown)
    
    with gr.Row():
        # --- å·¦é‚Šï¼šè¼¸å…¥ä»‹é¢ ---
        with gr.Column(scale=2):
            gr.Markdown("### 1. ğŸ“¡ è¼¸å…¥æ¸¬ç«™è³‡æ–™")
            
            station_type_input = gr.Radio(
                ["Land", "Marine"], 
                label="æ¸¬ç«™é¡å‹ (Station Type)", 
                value="Land"
            )
            
            g_obs_input = gr.Number(label="è§€æ¸¬é‡åŠ› (g_obs) [mGal]", value=980717.39)
            lat_input = gr.Number(label="ç·¯åº¦ (Latitude) [åº¦]", value=48.1195)
            lon_input = gr.Number(label="ç¶“åº¦ (Longitude) [åº¦]", value=12.1878)
            h_input = gr.Number(label="é«˜ç¨‹(é™¸åœ°) / æ°´æ·±(æµ·æ´‹) (h) [m]", value=487.9)
            
            with gr.Accordion("é€²éšé¸é … (å¯†åº¦)", open=False):
                rho_rock_input = gr.Slider(
                    minimum=1.0, 
                    maximum=3.5, 
                    value=2.67, 
                    step=0.01, 
                    label="åœ°æ®¼å²©çŸ³å¯†åº¦ (Ï_rock) [g/cmÂ³]"
                )
            
            submit_button = gr.Button("ğŸš€ ç”¢ç”Ÿå°ˆæ¥­å ±å‘Š", variant="primary")

        # --- å³é‚Šï¼šè¼¸å‡ºä»‹é¢ ---
        with gr.Column(scale=3):
            gr.Markdown("### 2. ğŸ“„ è¼¸å‡ºè¨ˆç®—å ±å‘Š")
            report_output = gr.Textbox(
                label="åœ°çƒç‰©ç†è¨ˆç®—çµæœ",
                lines=17,
                show_copy_button=True
            )

    # ç¶å®šæŒ‰éˆ•èˆ‡å‡½å¼
    submit_button.click(
        fn=calculate_gravity_report,
        inputs=[
            station_type_input,
            lat_input,
            lon_input,
            h_input,
            g_obs_input,
            rho_rock_input
        ],
        outputs=[report_output]
    )
    
    # å­¸ç”Ÿä½œæ¥­è³‡è¨Š
    gr.Markdown("---")
    gr.Markdown("ä½œæ¥­ä¸ƒ - åœ°çƒç‰©ç†é‡åŠ›è¨ˆç®— (å¯æ“´å±•æ¨¡çµ„ç‰ˆ)")

# å•Ÿå‹• APP
demo.launch()